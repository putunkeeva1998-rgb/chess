from fastapi import FastAPI, Body
from fastapi.middleware.cors import CORSMiddleware
import google.generativeai as genai
import chess
import chess.engine
import uvicorn  # <-- Вот этой строчки не хватало!

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# ТВОЙ КЛЮЧ GEMINI
genai.configure(api_key="AIzaSyBsNjahoG8BAzFYRBbA-42v16S44SOWzg4")
ai_model = genai.GenerativeModel('gemini-1.5-flash')

# ПУТЬ К STOCKFISH (на основе твоего Finder)
STOCKFISH_PATH = "/Users/tatiana/Downloads/stockfish/stockfish-macos-m1-apple-silicon"


@app.post("/analyze")
async def analyze(data: dict = Body(...)):
    fen = data.get("fen")
    board = chess.Board(fen)
    try:
        # Автоматически разрешаем запуск файла для системы
        os.chmod(STOCKFISH_PATH, 0o755)

        with chess.engine.SimpleEngine.popen_uci(STOCKFISH_PATH) as engine:
            analysis = engine.analyse(board, chess.engine.Limit(time=0.5), multipv=3)

        options = []
        for res in analysis:
            move = res["pv"][0]
            score = res["score"].relative.score(mate_score=10000) / 100
            options.append(f"Ход: {board.san(move)}, Оценка: {score}")

        prompt = f"Ты шахматный тренер. Позиция: {fen}. Ходы: {options}. Напиши 3 совета: Агрессор, Стратег, Хитрец."
        response = ai_model.generate_content(prompt)
        return {"advice": response.text}
    except Exception as e:
        return {"error": str(e)}


if __name__ == "__main__":
    uvicorn.run(app, host="127.0.0.1", port=8000)
